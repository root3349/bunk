<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>カラオケ記録アプリ</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; font-size: 3.8vw; line-height: 1.2; }
    .tabs { display: flex; position: sticky; top: 0; background: #333; }
    .tab { flex: 1; text-align: center; padding: 15px; color: white; cursor: pointer; font-size: 3.3vw; }
    .tab.active { background: #555; }
    .content { display: none; padding: 10px; }
    .content.active { display: block; }
    button { font-size: 2.8vw; padding: 3px 6px; margin: 1px; }

    /* レイアウトの改善 */
    .song-item {
      padding: 3px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: none;
      font-size: 3.3vw;
    }
    .song-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    .date { font-size: 2.3vw; color: #666; }

    /* ドロップダウンメニュー用のスタイル */
    #artistSelect {
        font-size: 3.8vw;
        padding: 8px;
        margin-bottom: 10px;
        width: 100%;
    }

    /* ポップアップ */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
    .modal-content input { width: 100%; margin: 10px 0; font-size: 3.3vw; padding: 10px; }
    h2 { font-size: 4.3vw; }
    h3 { font-size: 3.8vw; }
    .history-artist { font-size: 2.8vw; color: #666; margin-left: 8px; }
  </style>
</head>
<body>

  <div class="tabs">
    <div class="tab active" data-tab="songs">曲リスト</div>
    <div class="tab" data-tab="history">履歴</div>
  </div>

  <div id="songs" class="content active">
    <button onclick="openAddModal()">曲を追加</button>
    <div id="artist-selector"></div>
    <div id="songList"></div>
    <button id="clearDataButton" style="background-color: #ff4d4d; color: white;">全データを消去</button>
  </div>

  <div id="history" class="content">
    <h2>最近歌った曲</h2>
    <ol id="historyList"></ol>
  </div>

  <div id="addModal" class="modal">
    <div class="modal-content">
      <h3>曲を追加</h3>
      <input type="text" id="artistInput" placeholder="歌手名">
      <input type="text" id="artistKanaInput" placeholder="歌手名(読み)">
      <input type="text" id="titleInput" placeholder="曲名">
      <input type="text" id="titleKanaInput" placeholder="曲名(読み)">
      <button onclick="addSong()">追加</button>
      <button onclick="closeAddModal()">キャンセル</button>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>曲を編集</h3>
      <input type="text" id="editArtistInput" placeholder="歌手名">
      <input type="text" id="editArtistKanaInput" placeholder="歌手名(読み)">
      <input type="text" id="editTitleInput" placeholder="曲名">
      <input type="text" id="editTitleKanaInput" placeholder="曲名(読み)">
      <button onclick="saveEdit()">保存</button>
      <button onclick="closeEditModal()">キャンセル</button>
    </div>
  </div>

<script>
  let songs = JSON.parse(localStorage.getItem("songs") || "[]");
  let history = JSON.parse(localStorage.getItem("history") || "[]");
  let editingId = null;
  let groupedSongs = {};
  
  const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);
  songs = songs.map(song => {
    if (!song.id) {
      song.id = generateUniqueId();
    }
    return song;
  });
  saveData();

  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".content").forEach(c => c.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(tab.dataset.tab).classList.add("active");
      if(tab.dataset.tab === "songs") renderSongs();
      if(tab.dataset.tab === "history") renderHistory();
    });
  });

  // 修正箇所：モーダル表示時にフォームをリセット
  function openAddModal(artist = "", artistKana = "") {
    document.getElementById("artistInput").value = artist;
    document.getElementById("artistKanaInput").value = artistKana;
    document.getElementById("titleInput").value = "";
    document.getElementById("titleKanaInput").value = "";
    document.getElementById("addModal").style.display = "flex";
  }
  function closeAddModal() { document.getElementById("addModal").style.display = "none"; }

  function openEditModal(id) {
    editingId = id;
    let s = songs.find(song => song.id === id);
    if (!s) return;
    document.getElementById("editArtistInput").value = s.artist;
    document.getElementById("editArtistKanaInput").value = s.artistKana || "";
    document.getElementById("editTitleInput").value = s.title;
    document.getElementById("editTitleKanaInput").value = s.titleKana || "";
    document.getElementById("editModal").style.display = "flex";
  }
  function closeEditModal() { document.getElementById("editModal").style.display = "none"; }

  function addSong() {
    let artist = document.getElementById("artistInput").value.trim();
    let artistKana = document.getElementById("artistKanaInput").value.trim();
    let title = document.getElementById("titleInput").value.trim();
    let titleKana = document.getElementById("titleKanaInput").value.trim();
    if (!artist || !title) { alert("歌手名と曲名は必須です"); return; }
    const newSong = {id: generateUniqueId(), artist, artistKana, title, titleKana, dates: []};
    songs.push(newSong);
    saveData();
    closeAddModal();
    
    // 修正箇所：追加した歌手を自動で選択状態にする
    const currentArtistSelect = document.getElementById("artistSelect");
    if(currentArtistSelect) {
        currentArtistSelect.value = artist;
    }
    renderSongs();
    
    document.getElementById("artistInput").value = "";
    document.getElementById("artistKanaInput").value = "";
    document.getElementById("titleInput").value = "";
    document.getElementById("titleKanaInput").value = "";
  }

  function saveEdit() {
    let s = songs.find(song => song.id === editingId);
    if (!s) return;
    s.artist = document.getElementById("editArtistInput").value.trim();
    s.artistKana = document.getElementById("editArtistKanaInput").value.trim();
    s.title = document.getElementById("editTitleInput").value.trim();
    s.titleKana = document.getElementById("editTitleKanaInput").value.trim();
    saveData();
    closeEditModal();
    renderSongs();
  }

  function deleteSong(id) {
    if (confirm("この曲を削除しますか？")) {
      songs = songs.filter(song => song.id !== id);
      saveData();
      renderSongs();
    }
  }

  function singSong(id) {
    const today = new Date();
    const dateStr = today.getFullYear().toString().slice(2)
                  + String(today.getMonth()+1).padStart(2,"0")
                  + String(today.getDate()).padStart(2,"0");
    let song = songs.find(s => s.id === id);
    if (song) {
        song.dates.push(dateStr);
        history = history.filter(h => !(h.artist === song.artist && h.title === song.title));
        history.unshift({ artist: song.artist, title: song.title });
        if (history.length > 100) history.pop();
        saveData();
        renderSongs();
    }
  }

  function renderSongs() {
    const songListContainer = document.getElementById("songList");
    const artistSelectContainer = document.getElementById("artist-selector");
    
    const currentArtistSelect = document.getElementById("artistSelect");
    const selectedArtist = currentArtistSelect ? currentArtistSelect.value : "";
    
    songListContainer.innerHTML = "";
    artistSelectContainer.innerHTML = "";
    
    if (songs.length === 0) {
      songListContainer.textContent = "曲がありません。「曲を追加」ボタンから登録してください。";
      return;
    }

    groupedSongs = {};
    songs.forEach(s => {
      if (!groupedSongs[s.artist]) groupedSongs[s.artist] = [];
      groupedSongs[s.artist].push(s);
    });

    let artists = Object.keys(groupedSongs).sort((a,b)=>{
      let ak = (songs.find(s=>s.artist===a)?.artistKana)||a;
      let bk = (songs.find(s=>s.artist===b)?.artistKana)||b;
      return ak.localeCompare(bk,"ja");
    });
    
    const select = document.createElement("select");
    select.id = "artistSelect";
    select.innerHTML = `<option value="">歌手を選択してください</option>`;
    artists.forEach(artist => {
        const option = document.createElement("option");
        option.value = artist;
        option.textContent = artist;
        if (artist === selectedArtist) {
            option.selected = true;
        }
        select.appendChild(option);
    });
    
    artistSelectContainer.appendChild(select);
    
    const addBtn = document.createElement("button");
    addBtn.textContent = "この歌手に追加";
    addBtn.style.display = selectedArtist ? "inline-block" : "none";
    artistSelectContainer.appendChild(addBtn);

    select.addEventListener("change", (e) => {
        const selected = e.target.value;
        if (selected) {
            renderArtistSongs(selected);
            addBtn.style.display = "inline-block";
            addBtn.onclick = () => {
                const selectedArtistKana = (songs.find(s => s.artist === selected)?.artistKana) || "";
                openAddModal(selected, selectedArtistKana);
            };
        } else {
            songListContainer.innerHTML = "";
            addBtn.style.display = "none";
        }
    });

    if (selectedArtist) {
        renderArtistSongs(selectedArtist);
    }
  }

  function renderArtistSongs(artist) {
      const songListContainer = document.getElementById("songList");
      songListContainer.innerHTML = "";
      
      groupedSongs[artist].sort((a,b)=>{
        let ak = a.titleKana||a.title;
        let bk = b.titleKana||b.title;
        return ak.localeCompare(bk,"ja");
      }).forEach(s=>{
        let div = document.createElement("div");
        div.className="song-item";

        let songInfo = document.createElement("div");
        songInfo.className = "song-info";
        let songTitle = document.createElement("div");
        songTitle.textContent = s.title;
        let dateSpan = document.createElement("div");
        dateSpan.className = "date";
        let last = s.dates.length ? `最終:${s.dates[s.dates.length-1]}`:"";
        let prev = s.dates.length>1 ? ` 前回:${s.dates[s.dates.length-2]}`:"";
        dateSpan.textContent = `${last}${prev}`;
        songInfo.appendChild(songTitle);
        songInfo.appendChild(dateSpan);
        
        let btns = document.createElement("span");

        let singBtn = document.createElement("button");
        singBtn.textContent = "◎";
        
        let editBtn = document.createElement("button");
        editBtn.textContent = "✎";
        
        let delBtn = document.createElement("button");
        delBtn.textContent = "×";
        
        singBtn.addEventListener('click', () => {
            singSong(s.id);
        });
        editBtn.addEventListener('click', () => {
            openEditModal(s.id);
        });
        delBtn.addEventListener('click', () => {
            deleteSong(s.id);
        });
        
        btns.appendChild(singBtn);
        btns.appendChild(editBtn);
        btns.appendChild(delBtn);
        
        div.appendChild(songInfo);
        div.appendChild(btns);
        songListContainer.appendChild(div);
      });
  }

  function renderHistory() {
    const container = document.getElementById("historyList");
    container.innerHTML="";
    history.slice(0,100).forEach(h=>{
      let li=document.createElement("li");
      li.innerHTML=`${h.title} <span class="history-artist">${h.artist}</span>`;
      let singBtn=document.createElement("button");
      singBtn.textContent="◎";
      singBtn.onclick=()=>{
        let song = songs.find(s=>s.artist===h.artist && s.title===h.title);
        if (song) singSong(song.id);
      };
      li.appendChild(singBtn);
      container.appendChild(li);
    });
  }

  function clearAllData() {
    if (confirm("本当にすべてのデータを消去しますか？")) {
      if (confirm("この操作は元に戻せません！よろしいですか？")) {
        localStorage.clear();
        songs = [];
        history = [];
        renderSongs();
        alert("すべてのデータが消去されました。");
      }
    }
  }

  function saveData() {
    localStorage.setItem("songs", JSON.stringify(songs));
    localStorage.setItem("history", JSON.stringify(history));
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    const clearButton = document.getElementById('clearDataButton');
    if (clearButton) {
      clearButton.addEventListener('click', clearAllData);
    }
    renderSongs();
  });
</script>
</body>
</html>