<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>カラオケ記録アプリ</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; font-size: 3.8vw; line-height: 1.2; }
    .tabs { display: flex; position: sticky; top: 0; background: #333; }
    .tab { flex: 1; text-align: center; padding: 15px; color: white; cursor: pointer; font-size: 3.3vw; }
    .tab.active { background: #555; }
    .content { display: none; padding: 10px; }
    .content.active { display: block; }
    
    /* 共通ボタンのスタイルを統一 */
    button, .file-input-label { 
        font-size: 3.3vw; 
        padding: 8px 10px; 
        margin: 2px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: inline-block; 
        text-align: center;
        text-decoration: none;
        white-space: nowrap;
        box-sizing: border-box;
    }
    .file-input-label {
        background-color: #008CBA; 
        color: white; 
    }
    /* 曲リスト内の小さなボタンのサイズ */
    .song-item button { 
        font-size: 2.8vw; 
        padding: 3px 6px; 
        margin: 1px;
    }
    
    /* レイアウトの改善 */
    .song-item {
      /* ★★★ 修正: パディングを狭くして行の高さを低くする ★★★ */
      padding: 3px 0; 
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: none;
      font-size: 3.3vw;
      line-height: 1.1; /* 行の高さをさらに詰める */
    }
    .song-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      /* ★★★ 修正: 行間を詰めるためにマージンを調整 ★★★ */
      padding: 1px 0; 
    }
    .date { 
        font-size: 2.3vw; 
        color: #666; 
        line-height: 1; /* 日付表示の行を詰める */
    }

    /* アコーディオンメニュー用のスタイル */
    .accordion-header {
      background-color: #f2f2f2;
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }
    .accordion-content {
      display: none;
      padding: 10px;
    }
    .accordion-content.open {
      display: block;
    }
    
    /* 履歴リストのスタイル */
    #historyList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0; 
      border-bottom: 1px solid #eee;
    }
    #historyList li > div {
        line-height: 1.1; 
    }

    /* ポップアップ */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
    .modal-content input { width: 100%; margin: 10px 0; font-size: 3.3vw; padding: 10px; }
    h2 { font-size: 4.3vw; }
    h3 { font-size: 3.8vw; }
    .history-artist { font-size: 2.8vw; color: #666; margin-left: 8px; }

    /* データ操作ボタンコンテナ */
    .data-control-container {
        display: flex;
        justify-content: space-between; 
        margin-top: 15px; 
        flex-wrap: wrap; 
    }
    .data-control-container > * {
        flex: 1 1 30%; 
        margin: 2px;
    }

    /* 色のスタイル */
    .color-blue { color: #0000ff; }
    .color-green { color: #008000; }
    .color-brown { color: #a52a2a; }
    .color-orange { color: #ffa500; }
    .color-purple { color: #800080; }
    .color-red { color: #ff0000; }
  </style>
</head>
<body>

  <div class="tabs">
    <div class="tab active" data-tab="songs">曲リスト</div>
    <div class="tab" data-tab="history">履歴</div>
  </div>

  <div id="songs" class="content active">
    <button onclick="openAddModal()">曲を追加</button>
    <div id="artistList"></div>
    
    <div class="data-control-container">
        <label for="importFile" class="file-input-label">データ読込</label>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        
        <button onclick="exportData()" style="background-color: #4CAF50; color: white;">データ吐出</button>
        
        <button id="clearDataButton" style="background-color: #ff4d4d; color: white;">全データ消去</button>
    </div>
  </div>

  <div id="history" class="content">
    <h2>最近歌った曲</h2>
    <ul id="historyList"></ul>
  </div>

  <div id="addModal" class="modal">
    <div class="modal-content">
      <h3>曲を追加</h3>
      <input type="text" id="artistInput" placeholder="歌手名">
      <input type="text" id="artistKanaInput" placeholder="歌手名(読み)">
      <input type="text" id="titleInput" placeholder="曲名">
      <input type="text" id="titleKanaInput" placeholder="曲名(読み)">
      <button onclick="addSong()">追加</button>
      <button onclick="closeAddModal()">キャンセル</button>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>曲を編集</h3>
      <input type="text" id="editArtistInput" placeholder="歌手名">
      <input type="text" id="editArtistKanaInput" placeholder="歌手名(読み)">
      <input type="text" id="editTitleInput" placeholder="曲名">
      <input type="text" id="editTitleKanaInput" placeholder="曲名(読み)">
      <button onclick="saveEdit()">保存</button>
      <button onclick="closeEditModal()">キャンセル</button>
    </div>
  </div>

  <div id="editDatesModal" class="modal">
    <div class="modal-content">
        <h3>歌唱日を修正</h3>
        <p id="editDatesSongInfo"></p>
        <ul id="dateList"></ul>
        <div style="margin-top: 10px;">
          <input type="date" id="newDateInput">
          <button onclick="addNewDate()">日付を追加</button>
        </div>
        <button onclick="closeEditDatesModal()">完了</button>
    </div>
  </div>

<script>
  let songs = JSON.parse(localStorage.getItem("songs") || "[]");
  let history = []; 
  let editingId = null;
  let editingDatesSongId = null;
  
  const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);
  songs = songs.map(song => {
    if (!song.id) {
      song.id = generateUniqueId();
    }
    if (song.dates && song.dates.length > 5) {
        song.dates.sort((a,b) => a.localeCompare(b)); 
        song.dates = song.dates.slice(song.dates.length - 5); 
    }
    return song;
  });
  saveData();

  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".content").forEach(c => c.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(tab.dataset.tab).classList.add("active");
      if(tab.dataset.tab === "songs") renderSongs();
      if(tab.dataset.tab === "history") renderHistory();
    });
  });

  function openAddModal(artist = "", artistKana = "") {
    document.getElementById("artistInput").value = artist;
    document.getElementById("artistKanaInput").value = artistKana;
    document.getElementById("titleInput").value = "";
    document.getElementById("titleKanaInput").value = "";
    document.getElementById("addModal").style.display = "flex";
  }
  function closeAddModal() { document.getElementById("addModal").style.display = "none"; }

  function openEditModal(id) {
    editingId = id;
    let s = songs.find(song => song.id === id);
    if (!s) return;
    document.getElementById("editArtistInput").value = s.artist;
    document.getElementById("editArtistKanaInput").value = s.artistKana || "";
    document.getElementById("editTitleInput").value = s.title;
    document.getElementById("editTitleKanaInput").value = s.titleKana || "";
    document.getElementById("editModal").style.display = "flex";
  }
  function closeEditModal() { document.getElementById("editModal").style.display = "none"; }

  function openEditDatesModal(artist, title) {
    const song = songs.find(s => s.artist === artist && s.title === title);
    if (!song) return;

    editingDatesSongId = song.id;
    document.getElementById("editDatesSongInfo").textContent = `${song.title} (${song.artist})`;
    renderDateList(song.dates);

    document.getElementById("editDatesModal").style.display = "flex";
  }

  function closeEditDatesModal() { document.getElementById("editDatesModal").style.display = "none"; }

  function renderDateList(dates) {
      const dateList = document.getElementById("dateList");
      dateList.innerHTML = "";
      
      dates.sort((a, b) => b.localeCompare(a)).forEach(date => {
          const li = document.createElement("li");
          const formattedDate = `20${date.substring(0, 2)}年${date.substring(2, 4)}月${date.substring(4, 6)}日`;
          li.textContent = formattedDate;

          const delBtn = document.createElement("button");
          delBtn.textContent = "削除";
          delBtn.onclick = () => {
              if (confirm(`${formattedDate}の歌唱記録を削除しますか？`)) {
                  deleteDateFromSong(editingDatesSongId, date);
              }
          };
          li.appendChild(delBtn);
          dateList.appendChild(li);
      });
  }

  function addNewDate() {
      const newDateInput = document.getElementById("newDateInput");
      const dateValue = newDateInput.value;
      if (!dateValue) {
          alert("日付を入力してください。");
          return;
      }
      
      const [year, month, day] = dateValue.split('-');
      const formattedDate = year.substring(2) + month + day;
      
      const song = songs.find(s => s.id === editingDatesSongId);
      if (song) {
          if (!song.dates.includes(formattedDate)) {
              song.dates.push(formattedDate);
              song.dates.sort((a, b) => a.localeCompare(b)); 
              
              if (song.dates.length > 5) {
                song.dates.shift(); 
                alert(`歌唱記録が5回を超えたため、最も古い記録を自動削除しました。`);
              }

              saveData();
              renderDateList(song.dates);
              renderSongs();
              renderHistory();
          } else {
              alert("同じ日付は追加できません。");
          }
      }
      newDateInput.value = "";
  }

  function deleteDateFromSong(songId, dateToDelete) {
      const song = songs.find(s => s.id === songId);
      if (song) {
          song.dates = song.dates.filter(date => date !== dateToDelete);
          saveData();
          
          if (document.getElementById("editDatesModal").style.display === "flex" && editingDatesSongId === songId) {
             renderDateList(song.dates);
          }
          
          renderSongs();
          renderHistory();
      }
  }
  
  function deleteHistoryItem(artist, title, dateToDelete) {
    if (confirm(`履歴から ${artist} - ${title} (${dateToDelete}) の記録を削除しますか？`)) {
        const song = songs.find(s => s.artist === artist && s.title === title);
        if (song) {
            deleteDateFromSong(song.id, dateToDelete);
        } else {
            saveData();
            renderHistory();
        }
    }
  }

  function addSong() {
    let artist = document.getElementById("artistInput").value.trim();
    let artistKana = document.getElementById("artistKanaInput").value.trim();
    let title = document.getElementById("titleInput").value.trim();
    let titleKana = document.getElementById("titleKanaInput").value.trim();
    if (!artist || !title) { alert("歌手名と曲名は必須です"); return; }
    const newSong = {id: generateUniqueId(), artist, artistKana, title, titleKana, dates: []};
    songs.push(newSong);
    saveData();
    closeAddModal();
    renderSongs();
  }

  function saveEdit() {
    let s = songs.find(song => song.id === editingId);
    if (!s) return;
    s.artist = document.getElementById("editArtistInput").value.trim();
    s.artistKana = document.getElementById("editArtistKanaInput").value.trim();
    s.title = document.getElementById("editTitleInput").value.trim();
    s.titleKana = document.getElementById("editTitleKanaInput").value.trim();
    saveData();
    closeEditModal();
    renderSongs();
  }

  function deleteSong(id) {
    if (confirm("この曲を削除しますか？")) {
      songs = songs.filter(song => song.id !== id);
      saveData();
      renderSongs();
    }
  }

  function singSong(id) {
    const today = new Date();
    const dateStr = today.getFullYear().toString().slice(2)
                  + String(today.getMonth()+1).padStart(2,"0")
                  + String(today.getDate()).padStart(2,"0");
    let song = songs.find(s => s.id === id);
    if (song) {
        song.dates.push(dateStr);
        song.dates.sort((a,b)=>a.localeCompare(b)); 

        if (song.dates.length > 5) {
            song.dates.shift(); 
        }
        
        saveData(); 
        renderSongs(song.artist);
        renderHistory(); 
    }
  }

  function clearAllData() {
    if (confirm("本当にすべてのデータを消去しますか？")) {
      if (confirm("この操作は元に戻せません！よろしいですか？")) {
        localStorage.clear();
        songs = [];
        history = []; 
        renderSongs();
        renderHistory();
        alert("すべてのデータが消去されました。");
      }
    }
  }

  function saveData() {
    localStorage.setItem("songs", JSON.stringify(songs));
    localStorage.setItem("history", "[]"); 
  }
  
  function renderSongs(openArtist = null) {
    const artistListContainer = document.getElementById("artistList");
    artistListContainer.innerHTML = "";
    
    if (songs.length === 0) {
      artistListContainer.textContent = "曲がありません。「曲を追加」ボタンから登録してください。";
      return;
    }

    const groupedSongs = {};
    songs.forEach(s => {
      if (!groupedSongs[s.artist]) groupedSongs[s.artist] = [];
      groupedSongs[s.artist].push(s);
    });

    const artists = Object.keys(groupedSongs).sort((a,b)=>{
      const ak = (songs.find(s=>s.artist===a)?.artistKana)||a;
      const bk = (songs.find(s=>s.artist===b)?.artistKana)||b;
      return ak.localeCompare(bk,"ja");
    });
    
    const today = new Date();

    artists.forEach(artist => {
        const accordionContainer = document.createElement("div");
        accordionContainer.className = "accordion-container";

        const header = document.createElement("div");
        header.className = "accordion-header";
        header.textContent = artist;

        const content = document.createElement("div");
        content.className = "accordion-content";
        
        if (artist === openArtist) {
            content.classList.add("open");
        }

        groupedSongs[artist].sort((a,b)=>{
            const ak = a.titleKana||a.title;
            const bk = b.titleKana||b.title;
            return ak.localeCompare(bk,"ja");
        }).forEach(s => {
            const div = document.createElement("div");
            div.className = "song-item";

            const songInfo = document.createElement("div");
            songInfo.className = "song-info";
            const songTitle = document.createElement("div");
            songTitle.textContent = s.title;

            const sortedDates = s.dates.slice().sort((a,b)=>b.localeCompare(a)); 
            
            if (sortedDates.length > 0) {
              const lastDateStr = sortedDates[0];
              const year = 2000 + parseInt(lastDateStr.substring(0, 2));
              const month = parseInt(lastDateStr.substring(2, 4)) - 1;
              const day = parseInt(lastDateStr.substring(4, 6));
              const lastSungDate = new Date(year, month, day);

              const diffMonths = (today.getFullYear() - lastSungDate.getFullYear()) * 12 + today.getMonth() - lastSungDate.getMonth();
              
              if (diffMonths < 1) {
                songTitle.classList.add('color-blue');
              } else if (diffMonths < 2) {
                songTitle.classList.add('color-green');
              } else if (diffMonths < 3) {
                songTitle.classList.add('color-brown');
              } else if (diffMonths < 4) {
                songTitle.classList.add('color-orange');
              } else if (diffMonths < 5) {
                songTitle.classList.add('color-purple');
              } else {
                songTitle.classList.add('color-red');
              }
            }

            const dateSpan = document.createElement("div");
            dateSpan.className = "date";
            
            const last = sortedDates.length ? `最終:${sortedDates[0]}` : "";
            const prev = sortedDates.length > 1 ? ` 前回:${sortedDates[1]}` : "";
            dateSpan.textContent = `${last}${prev}`;
            
            songInfo.appendChild(songTitle);
            songInfo.appendChild(dateSpan);
            
            const btns = document.createElement("span");

            const singBtn = document.createElement("button");
            singBtn.textContent = "◎";
            
            const editBtn = document.createElement("button");
            editBtn.textContent = "✎";
            
            const delBtn = document.createElement("button");
            delBtn.textContent = "×";
            
            singBtn.addEventListener('click', () => { singSong(s.id); });
            editBtn.addEventListener('click', () => { openEditModal(s.id); });
            delBtn.addEventListener('click', () => { deleteSong(s.id); });
            
            btns.appendChild(singBtn);
            btns.appendChild(editBtn);
            btns.appendChild(delBtn);
            
            div.appendChild(songInfo);
            div.appendChild(btns);
            content.appendChild(div);
        });

        const addBtn = document.createElement("button");
        addBtn.textContent = "曲を追加";
        addBtn.onclick = () => {
            const selectedArtistKana = (songs.find(s => s.artist === artist)?.artistKana) || "";
            openAddModal(artist, selectedArtistKana);
        };
        header.appendChild(addBtn);

        header.addEventListener("click", () => {
            content.classList.toggle("open");
        });
        
        accordionContainer.appendChild(header);
        accordionContainer.appendChild(content);
        artistListContainer.appendChild(accordionContainer);
    });
  }

  function renderHistory() {
    const container = document.getElementById("historyList");
    container.innerHTML="";
    const today = new Date();
    
    let tempHistory = [];
    songs.forEach(song => {
        song.dates.forEach(date => {
            tempHistory.push({
                artist: song.artist,
                title: song.title,
                date: date, 
                songId: song.id 
            });
        });
    });

    tempHistory.sort((a, b) => b.date.localeCompare(a.date));

    // 表示件数300曲は維持
    tempHistory.slice(0,300).forEach(h=>{
      let li=document.createElement("li");
      li.dataset.date = h.date; 
      
      let itemText=document.createElement("div");
      
      const songTitle = document.createElement("span");
      songTitle.textContent = h.title;
      
      const songData = songs.find(s => s.title === h.title && s.artist === h.artist);
      if (songData && songData.dates.length > 0) {
          const sortedDates = songData.dates.slice().sort((a,b)=>b.localeCompare(a));
          const lastDateStr = sortedDates[0];
          const year = 2000 + parseInt(lastDateStr.substring(0, 2));
          const month = parseInt(lastDateStr.substring(2, 4)) - 1;
          const day = parseInt(lastDateStr.substring(4, 6));
          const lastSungDate = new Date(year, month, day);

          const diffMonths = (today.getFullYear() - lastSungDate.getFullYear()) * 12 + today.getMonth() - lastSungDate.getMonth();
          
          if (diffMonths < 1) {
            songTitle.classList.add('color-blue');
          } else if (diffMonths < 2) {
            songTitle.classList.add('color-green');
          } else if (diffMonths < 3) {
            songTitle.classList.add('color-brown');
          } else if (diffMonths < 4) {
            songTitle.classList.add('color-orange');
          } else if (diffMonths < 5) {
            songTitle.classList.add('color-purple');
          } else {
            songTitle.classList.add('color-red');
          }
      }
      
      const artistSpan = document.createElement("span");
      artistSpan.className = "history-artist";
      artistSpan.textContent = `${h.artist} (${h.date})`; 
      
      itemText.appendChild(songTitle);
      itemText.appendChild(artistSpan);

      let btns = document.createElement("div");
      
      let singBtn=document.createElement("button");
      singBtn.textContent="◎";
      singBtn.onclick=()=>{
        let song = songs.find(s=>s.artist===h.artist && s.title===h.title);
        if (song) singSong(song.id);
      };

      let editDatesBtn = document.createElement("button");
      editDatesBtn.textContent = "✎";
      editDatesBtn.onclick = () => {
          openEditDatesModal(h.artist, h.title);
      };

      let delBtn = document.createElement("button");
      delBtn.textContent = "×";
      delBtn.onclick = () => {
        deleteHistoryItem(h.artist, h.title, h.date);
      };

      btns.appendChild(singBtn);
      btns.appendChild(editDatesBtn);
      btns.appendChild(delBtn);
      
      li.appendChild(itemText);
      li.appendChild(btns);
      container.appendChild(li);
    });
  }
  
  // データのエクスポート
  function exportData() {
    const dataStr = JSON.stringify(songs, null, 2); 
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

    const exportFileName = 'karaoke_data_' + new Date().toISOString().slice(0,10).replace(/-/g,"") + '.json';

    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileName);
    linkElement.click();
    alert(`全曲データ (${songs.length}件) を ${exportFileName} としてエクスポートしました！`);
  }

  // データのインポート
  function importData(event) {
    if (!confirm("現在のデータは上書きされます。インポートを実行しますか？")) {
        event.target.value = ''; 
        return;
    }
    
    const file = event.target.files[0];
    if (!file) {
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedSongs = JSON.parse(e.target.result);
        
        if (!Array.isArray(importedSongs) || importedSongs.some(item => !item.artist || !item.title)) {
          alert('インポートしたファイルの形式が正しくありません。');
          return;
        }

        songs = importedSongs;
        saveData();
        renderSongs();
        renderHistory();
        alert(`データを正常に読み込みました！ (${songs.length}件)`);

      } catch (error) {
        alert('ファイルの解析に失敗しました。ファイルの内容を確認してください。');
        console.error("Import Error:", error);
      }
      event.target.value = ''; 
    };
    reader.readAsText(file);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const clearButton = document.getElementById('clearDataButton');
    if (clearButton) {
      clearButton.addEventListener('click', clearAllData);
    }
    renderSongs();
    renderHistory();
  });
</script>
</body>
</html>